<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="/css/member/style.css" />
    <link rel="stylesheet" href="/css/button.css" />
    <link rel="stylesheet" href="/css/member/component/comment.css" />
    <link rel="stylesheet" href="/css/member/component/profile-box.css">
  </head>
  <body>
    <section class="comment">
      <h2 class="comment__num" th:text="'댓글 ' + ${countOfComment}+' 개'">N</h2>
      <div class="comment__input-container"> 
          <textarea
          class="comment__input"
          name="comment-text"
          id="comment-text"
          placeholder="댓글을 입력하세요."
          ></textarea>
          <span class="comment__btn btn btn-round" id="register-btn">등록하기</span>
      </div>
      <ul class="comment__list">
       
          <li th:each="comment:${comments}">
              <div class="profile"> 
                  <span class="profile__image" th:text="${comment.profileImgPath}"></span>
                  <span class="profile__nickname" th:text="${comment.nickname}">찬우몬</span>
                  <span class="profile__time" th:text="${comment.elapsedTime}">3분전</span>
                  <button></button>
              </div>
              <span class="comment__content" th:text="${comment.content}">
                  이 헌법에 의한 최초의 대통령의 임기는 이 헌법시행일로부터 개시한다. 모든 국민은 거주·이전의 자유를 가진다. 대통령은 제1항과 제2항의 처분 또는 명령을 한 때에는 지체없이 국회에 보고하여 그 승인을 얻어야 한다.
              </span>
              <div class="comment__replies">
                      <span th:text="'답글 '+${comment.countOfReply}+'개'">답글 n개</span>
                      <span>답글 달기</span>
              </div>
          </li>
          	<template id="template">
          <li>
              <div class="profile"> 
                  <span class="profile__image" ></span>
                  <span class="profile__nickname" ></span>
                  <span class="profile__time"></span>
                  <button></button>
              </div>
              <span class="comment__content" ></span>
              <div class="comment__replies">
                      <span>답글 달기</span>
              </div>
          </li>
         </template>
      </ul>
  </section>
  </body>
  <script>
  
  	function addNewCommentElement(newText){
  		
  		if(newText != ""){
	  		const template = document.querySelector("#template");
	  		const sourceNode = window.template.content.querySelector("li");
	  		const newNode = sourceNode.cloneNode(true);
	  		const textSpan = newNode.querySelector('.comment__content');
	  		const newContent = document.createTextNode(newText);
	  		textSpan.appendChild(newContent);
	  		const targetNode = document.querySelector(".comment__list li:last-child");
	  		if(targetNode ==null)
	  			template.after(newNode);
	  		else
	  			targetNode.after(newNode);
  		}
  		
  	}	
  
    window.addEventListener("load", (e) => {
        const registerBtn = document.querySelector("#register-btn");

        registerBtn.addEventListener("click",(e) => {
            e.preventDefault();

            const commentText = document.querySelector("#comment-text").value;

            const data = {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    "content":commentText,
                    "writerId":3,
                    "meetingId":1
                })
            }

            fetch("http://localhost:8080/comment", data)
            .then(response => {
		        const newCommentText = document.getElementById("comment-text").value;
            	if(newCommentText){
	            	if(response.ok){
		            	addNewCommentElement(newCommentText);
	            	}
	            	else alert("시스템 장애로 등록이 안되고 있습니다.");
	            }
	            else alert("댓글을 입력해주세요.");
            });
            
        });
    });
</script>
</html>

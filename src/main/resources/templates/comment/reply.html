<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="/css/member/style.css" />
    <link rel="stylesheet" href="/css/button.css" />
    <link rel="stylesheet" href="/css/member/component/reply.css" />
    <link rel="stylesheet" href="/css/member/component/profile-box.css">
  </head>
  <body>
    <section class="reply">
      <ul class="reply__list">
          <li th:each="reply:${replies}">
              <div class="profile"> 
                  <span class="profile__image" th:text="${reply.profileImgPath}"></span>
                  <span class="profile__nickname profile__nickname" th:text="${reply.nickname}">찬우몬</span>
                  <span class="profile__time" th:text="${reply.elapsedTime}">3분전</span>
                  <button></button>
              </div>
              <div class="reply-container">
              <span class="reply__at-symbol" th:if="${not #strings.isEmpty(reply.parentNickname)}">@</span><!--span사이 공백없애기 
               --><span class="reply__to" th:text="${reply.parentNickname}?:''">채누</span>
              <span class="reply__content" th:text="${reply.content}">
                  이 헌법에 의한 최초의 대통령의 임기는 이 헌법시행일로부터 개시한다. 모든 국민은 거주·이전의 자유를 가진다. 대통령은 제1항과 제2항의 처분 또는 명령을 한 때에는 지체없이 국회에 보고하여 그 승인을 얻어야 한다.
              </span>
              </div>
              <div class="reply__replies">
                      <span>답글 달기</span>
              </div>
          </li>
          <template id="template">
          	<li >
              <div class="profile"> 
                  <span class="profile__image"></span>
                  <span class="profile__nickname profile__nickname" ></span>
                  <span class="profile__time" ></span>
                  <button></button>
              </div>
              <div class="reply-container">
              <span class="reply__at-symbol" ></span><!--span사이 공백없애기 
               --><span class="reply__to" ></span>
              <span class="reply__content" ></span>
              </div>
              <div id="add-reply" class="reply__replies">
                      <span>답글 달기</span>
              </div>
          </li>
          </template>
      </ul>
      
  </section>
  </body>
  <script type="text/javascript">
  
	
  	 window.addEventListener("load", (e) => {
        const addReplyLinkList = document.querySelectorAll(".reply__replies");
		const replySection = document.querySelector(".reply");
		for(addReplyLink of addReplyLinkList)
	        addReplyLink.addEventListener("click",(e) => {
	            e.preventDefault();
	        	let template = `
		        	<div class="reply__input-container"> 
				        <textarea
				        id="reply-text"
				        class="reply__input"
				        name="reply-input"
				        placeholder="답글을 입력하세요."
				        ></textarea>
				        <span id="register-btn" class="reply__btn btn btn-round">등록하기</span>
		    		</div>
	        		`;
	        	e.target.parentElement.insertAdjacentHTML("afterend",template);//클릭된 특정 답글링크의 위치아래에 element추가.
	        	
	        	const registerBtn = document.querySelector("#register-btn");
	        	registerBtn.addEventListener("click",(e) => {
	                e.preventDefault();
	
	                const replyText = document.querySelector("#reply-text").value;
	
	                const data = {
	                    method: "POST",
	                    headers: {
	                        "Content-Type": "application/json",
	                    },
	                    body: JSON.stringify({
	                        "content":replyText,
	                        "writerId":2,
	                        "meetingId":1
	                    })
	                }
	
	                fetch("http://localhost:8080/reply", data)
	                .then(response => {
	    		        const newReplyText = document.getElementById("reply-text").value;
	                	if(newReplyText){
	    	            	if(response.ok){
	    		            	addNewReplyElement(newReplyText);
	    	            	}
	    	            	else alert("시스템 장애로 등록이 안되고 있습니다.");
	    	            }
	    	            else alert("댓글을 입력해주세요.");
	                });
	            });//end of registerBtn event handler
	  		}); //end of for-loop & end of addReplyLink.addEventListener
  	});//end of window.load
  	 
  	function addNewReplyElement(newText){
	    if(newText != ""){
	        const template = document.querySelector("#template");
	        const sourceNode = window.template.content.querySelector("li");
	        const newNode = sourceNode.cloneNode(true);
	        const textSpan = newNode.querySelector('.reply__content');
	        const newContent = document.createTextNode(newText);
	        textSpan.appendChild(newContent);
	        const targetNode = document.querySelector(".reply__list").lastElementChild;
	        targetNode.after(newNode);
	        document.querySelector(".reply__input-container").remove();
	    }
	}	
  
  
  </script>
</html>
